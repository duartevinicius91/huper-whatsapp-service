name: Deploy to VPS

on:
  push:
    branches:
      - main  # Ajuste para a branch principal do seu projeto
  workflow_dispatch:  # Permite execução manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to VPS
        run: |
          DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
          if [ -z "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="/opt/whatsapp-service"
          fi
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'auth' \
            -e ssh \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$DEPLOY_PATH/

      - name: Build and deploy Docker container
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            set -e
            
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
            if [ -z "\$DEPLOY_PATH" ]; then
              DEPLOY_PATH="/opt/whatsapp-service"
            fi
            
            # Criar diretório se não existir
            mkdir -p "\$DEPLOY_PATH"
            cd "\$DEPLOY_PATH"
            
            # Criar diretório auth se não existir
            mkdir -p auth
            
            # Parar e remover container antigo se existir
            if [ "$(docker ps -aq -f name=whatsapp-web-app)" ]; then
              echo "Parando container antigo..."
              docker stop whatsapp-web-app || true
              docker rm whatsapp-web-app || true
            fi
            
            # Remover imagem antiga se existir (opcional, para economizar espaço)
            if [ "$(docker images -q whatsapp-web-app:latest)" ]; then
              echo "Removendo imagem antiga..."
              docker rmi whatsapp-web-app:latest || true
            fi
            
            # Fazer build da nova imagem
            echo "Fazendo build da nova imagem Docker..."
            docker build -t whatsapp-web-app:latest .
            
            # Rodar o novo container usando docker-compose ou docker run
            echo "Iniciando novo container..."
            
            # Verificar se existe arquivo .env no VPS
            if [ ! -f .env ]; then
              echo "AVISO: Arquivo .env não encontrado. Certifique-se de configurá-lo no VPS."
              echo "O container será iniciado sem variáveis de ambiente do arquivo .env"
            fi
            
            # Usar docker-compose se disponível, senão usar docker run
            if command -v docker-compose &> /dev/null || command -v docker compose &> /dev/null; then
              if command -v docker compose &> /dev/null; then
                docker compose up -d
              else
                docker-compose up -d
              fi
            else
              # Fallback para docker run com as mesmas configurações do docker-compose
              ENV_FILE_FLAG=""
              if [ -f .env ]; then
                ENV_FILE_FLAG="--env-file .env"
              fi
              
              docker run -d \
                --name whatsapp-web-app \
                --restart unless-stopped \
                -p 3000:3000 \
                $ENV_FILE_FLAG \
                -v "\$DEPLOY_PATH/auth:/app/auth" \
                --shm-size=2g \
                --memory="2g" \
                --memory-reservation="512m" \
                whatsapp-web-app:latest
            fi
            
            # Limpar imagens não utilizadas
            echo "Limpando imagens Docker não utilizadas..."
            docker image prune -f
            
            echo "Deploy concluído com sucesso!"
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            echo "Verificando status do container..."
            docker ps -a | grep whatsapp-web-app || echo "Container não encontrado"
            
            echo "Verificando logs recentes..."
            docker logs --tail 20 whatsapp-web-app || echo "Não foi possível ler os logs"
          EOF

