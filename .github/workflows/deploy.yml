name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:  # Permite execução manual
    inputs:
      image_tag:
        description: 'Tag da imagem Docker (ex: latest, main-abc123)'
        required: false
        default: 'latest'

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME || 'your-username' }}/whatsapp-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Determine image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Copy docker-compose.yml to VPS
        run: |
          DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
          if [ -z "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="/opt/whatsapp-service"
          fi
          
          # Criar diretório no VPS se não existir
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p $DEPLOY_PATH"
          
          # Copiar apenas docker-compose.yml
          scp docker-compose.yml ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$DEPLOY_PATH/docker-compose.yml

      - name: Update Docker container on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            set -e
            
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
            if [ -z "\$DEPLOY_PATH" ]; then
              DEPLOY_PATH="/opt/whatsapp-service"
            fi
            
            cd "\$DEPLOY_PATH"
            
            # Criar diretório auth se não existir
            mkdir -p auth
            
            # Login no Docker Hub (se necessário)
            if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
              echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || true
            fi
            
            # Fazer pull da nova imagem
            IMAGE_TAG="${{ steps.image_tag.outputs.tag }}"
            IMAGE_NAME="${{ env.DOCKER_IMAGE }}:\$IMAGE_TAG"
            echo "Fazendo pull da imagem: \$IMAGE_NAME"
            docker pull \$IMAGE_NAME || {
              echo "Erro ao fazer pull da imagem. Tentando com tag 'latest'..."
              IMAGE_NAME="${{ env.DOCKER_IMAGE }}:latest"
              docker pull \$IMAGE_NAME
            }
            
            # Parar e remover container antigo se existir
            if [ "\$(docker ps -aq -f name=whatsapp-web-app)" ]; then
              echo "Parando container antigo..."
              docker stop whatsapp-web-app || true
              docker rm whatsapp-web-app || true
            fi
            
            # Atualizar docker-compose.yml para usar a imagem do Docker Hub
            # Substituir a seção build por image no docker-compose.yml existente
            if [ -f docker-compose.yml ]; then
              # Criar backup
              cp docker-compose.yml docker-compose.yml.bak
              
              # Atualizar docker-compose.yml para usar a imagem do Docker Hub
              sed -i "s|build:.*|image: \$IMAGE_NAME|g" docker-compose.yml
              sed -i "/dockerfile:/d" docker-compose.yml
              sed -i "/context:/d" docker-compose.yml
            else
              # Criar docker-compose.yml se não existir
              cat > docker-compose.yml << 'COMPOSE_EOF'
          version: '3.8'
          
          services:
            whatsapp-web:
              image: PLACEHOLDER_IMAGE
              container_name: whatsapp-web-app
              ports:
                - "${PORT:-3000}:3000"
              environment:
                - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                - AWS_REGION=${AWS_REGION:-us-east-1}
                - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
                - AWS_S3_REMOTE_DATA_PATH=${AWS_S3_REMOTE_DATA_PATH:-whatsapp-sessions/}
                - PORT=${PORT:-3000}
                - NODE_ENV=${NODE_ENV:-production}
                - DEBUG=${DEBUG:-false}
                - LOG_LEVEL=${LOG_LEVEL:-info}
              volumes:
                - ./auth:/app/auth
              restart: unless-stopped
              shm_size: '2gb'
              deploy:
                resources:
                  limits:
                    memory: 2G
                  reservations:
                    memory: 512M
          COMPOSE_EOF
              sed -i "s|PLACEHOLDER_IMAGE|\$IMAGE_NAME|g" docker-compose.yml
            fi
            
            # Verificar se existe arquivo .env no VPS
            if [ ! -f .env ]; then
              echo "AVISO: Arquivo .env não encontrado. Certifique-se de configurá-lo no VPS."
              echo "O container será iniciado sem variáveis de ambiente do arquivo .env"
            fi
            
            # Usar docker-compose se disponível, senão usar docker run
            if command -v docker-compose &> /dev/null || command -v docker compose &> /dev/null; then
              if command -v docker compose &> /dev/null; then
                docker compose up -d
              else
                docker-compose up -d
              fi
            else
              # Fallback para docker run com as mesmas configurações do docker-compose
              ENV_FILE_FLAG=""
              if [ -f .env ]; then
                ENV_FILE_FLAG="--env-file .env"
              fi
              
              docker run -d \
                --name whatsapp-web-app \
                --restart unless-stopped \
                -p 3000:3000 \
                \$ENV_FILE_FLAG \
                -v "\$DEPLOY_PATH/auth:/app/auth" \
                --shm-size=2g \
                --memory="2g" \
                --memory-reservation="512m" \
                \$IMAGE_NAME
            fi
            
            # Limpar imagens não utilizadas
            echo "Limpando imagens Docker não utilizadas..."
            docker image prune -f
            
            echo "Deploy concluído com sucesso!"
            echo "Imagem utilizada: \$IMAGE_NAME"
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            echo "Verificando status do container..."
            docker ps -a | grep whatsapp-web-app || echo "Container não encontrado"
            
            echo "Verificando logs recentes..."
            docker logs --tail 20 whatsapp-web-app || echo "Não foi possível ler os logs"
          EOF

