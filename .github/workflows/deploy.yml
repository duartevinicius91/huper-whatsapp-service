name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build and push image"]
    types:
      - completed
  workflow_dispatch:  # Permite execução manual

env:
  DOCKER_IMAGE: duartevinicius91/huper-whatsapp-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Update Docker container on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            set -e
            
            IMAGE_NAME="${{ env.DOCKER_IMAGE }}:latest"
            
            echo "Fazendo pull da nova imagem: \$IMAGE_NAME"
            docker pull \$IMAGE_NAME
            
            # Parar e remover container antigo se existir
            if [ "\$(docker ps -aq -f name=whatsapp-web-app)" ]; then
              echo "Parando container antigo..."
              docker stop whatsapp-web-app || true
              docker rm whatsapp-web-app || true
            fi
            
            # Iniciar novo container usando docker-compose se disponível
            if [ -f docker-compose.yml ] && (command -v docker-compose &> /dev/null || command -v docker compose &> /dev/null); then
              echo "Usando docker-compose para iniciar o container..."
              if command -v docker compose &> /dev/null; then
                docker compose up -d
              else
                docker-compose up -d
              fi
            else
              echo "Usando docker run para iniciar o container..."
              # Verificar se existe arquivo .env
              ENV_FILE_FLAG=""
              if [ -f .env ]; then
                ENV_FILE_FLAG="--env-file .env"
              fi
              
              docker run -d \
                --name whatsapp-web-app \
                --restart unless-stopped \
                -p 3000:3000 \
                \$ENV_FILE_FLAG \
                -v "\$(pwd)/auth:/app/auth" \
                --shm-size=2g \
                --memory="2g" \
                --memory-reservation="512m" \
                \$IMAGE_NAME
            fi
            
            # Limpar imagens não utilizadas
            echo "Limpando imagens Docker não utilizadas..."
            docker image prune -f
            
            echo "Container atualizado com sucesso!"
            echo "Imagem utilizada: \$IMAGE_NAME"
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            echo "Verificando status do container..."
            docker ps -a | grep whatsapp-web-app || echo "Container não encontrado"
            
            echo "Verificando logs recentes..."
            docker logs --tail 20 whatsapp-web-app || echo "Não foi possível ler os logs"
          EOF

